# MoySklad Loyalty Discounts

Автоматизация применения скидок по программе лояльности для оптовых контрагентов в МойСклад.

## Быстрый старт

```bash
python -m venv .venv
.\.venv\Scripts\activate       # Windows
pip install -r ms_loyalty/requirements.txt

# скопировать и заполнить конфиг
copy ms_loyalty\.env.example ms_loyalty\.env
# → прописать MS_TOKEN (или MS_LOGIN + MS_PASSWORD)

# запустить сервис
python -m uvicorn ms_loyalty.app.main:app --reload --port 8080
```

## Конфигурация (.env)

```env
MS_BASE_URL=https://api.moysklad.ru/api/remap/1.2
MS_AUTH_MODE=bearer            # bearer | basic
MS_TOKEN=...                   # для bearer
# MS_LOGIN=...                 # для basic
# MS_PASSWORD=...              # для basic

DOCUMENT_TYPES=customerorder,demand

# --- контрагент ---
LOYALTY_ENABLED_ATTR=Программа лояльности   # чекбокс участия в ПЛ
LOYALTY_DISCOUNT_ATTR=Скидка по ПЛ (%)       # процент скидки
WHOLESALER_TAG=Оптовик                       # тег (группа контрагентов)

# --- акционные товары ---
PROMO_GROUP_NAME=Акция                       # папка товаров

DRY_RUN=false
LOG_LEVEL=INFO
WEBHOOK_BEARER_TOKEN=
REQUEST_TIMEOUT=20
```

## Настройка в МойСклад

### Контрагент (карточка)
1. Добавить тег **Оптовик** (Настройки → Группы контрагентов).
2. Создать доп. поле **Программа лояльности** (тип: Флажок).
3. Создать доп. поле **Скидка по ПЛ (%)** (тип: Число).
4. Для каждого оптовика: включить чекбокс, указать процент, назначить тег «Оптовик».

### Товары
- Создать группу товаров **Акция**.
- Перемещать товары в папку «Акция», когда они участвуют в акции.
- На акционные товары скидка по ПЛ **не применяется** — для них используется акционная цена.

### Вебхуки
Создать вебхуки на **создание** и **изменение** документов:
- Заказ покупателя (`customerorder`)
- Отгрузка (`demand`)

URL: `https://<ваш_хост>/webhook`

Если задан `WEBHOOK_BEARER_TOKEN`, запрос должен содержать заголовок `Authorization: Bearer <token>`.

## Бизнес-логика

```
Webhook → получаем документ → проверяем контрагента:
  ✓ чекбокс «Программа лояльности» = Да
  ✓ тег «Оптовик» у контрагента
  ✓ «Скидка по ПЛ (%)» > 0
  → для каждой позиции:
      если товар в папке «Акция» → скидка = 0% (акционная цена)
      иначе → скидка = % из карточки контрагента
```

Поведение:
- Скидки проставляются автоматически при создании/изменении документа.
- При любом изменении (замена товара, смена контрагента, ручная правка скидки) система повторно пересчитывает все позиции.
- Менеджер не может «перебить» скидку вручную — система перезапишет её при следующем событии.
- Отключение ПЛ для контрагента — снять чекбокс «Программа лояльности» в карточке.

## Ручной запуск

```bash
python -m ms_loyalty.scripts.apply_discounts --type customerorder --id <UUID>
```

## Тесты

```bash
pytest ms_loyalty/tests/ -v
```
