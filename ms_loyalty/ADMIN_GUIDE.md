# Инструкция для администратора (МойСклад)

## 1. Настройка контрагентов

### Группа контрагентов
В МойСклад: **Контрагенты → Настройки → Группы контрагентов**.
Создайте группу (тег) **Оптовик** (если ещё нет).

### Дополнительные поля контрагента
Перейдите в карточку любого контрагента → **Ещё → Дополнительные поля**:
1. **Программа лояльности** (тип: Флажок) — участвует ли контрагент в ПЛ
2. **Скидка по ПЛ (%)** (тип: Число) — размер скидки (например 3, 7, 10)

### Как подключить контрагента к ПЛ
1. Откройте карточку контрагента.
2. Добавьте тег **Оптовик**.
3. Установите флажок **Программа лояльности** = Да.
4. Укажите **Скидка по ПЛ (%)** — например 7.

### Как отключить контрагента от ПЛ
Снимите флажок **Программа лояльности** в карточке контрагента.
При следующем изменении документа с этим контрагентом скидки будут обнулены.

## 2. Настройка акционных товаров

### Группа товаров
В МойСклад: **Товары и услуги** — создайте группу (папку) **Акция**.

### Как пометить товар как акционный
Перенесите товар в группу **Акция** (или в подпапку внутри неё).
На этот товар скидка по ПЛ **не применяется** — используется акционная цена.

### Как снять товар с акции
Переместите товар обратно в обычную группу.
При следующем изменении документа скидка по ПЛ будет автоматически применена.

## 3. Права доступа

Пользователь, чей токен используется сервисом, должен иметь:
- Просмотр и изменение **Заказов покупателей**
- Просмотр и изменение **Отгрузок**
- Доступ к **дополнительным полям** контрагентов
- Доступ к **позициям документов**
- Доступ к **товарам** (для чтения pathName / productFolder)

## 4. Настройка вебхуков

Перейдите в **Настройки → Вебхуки** и создайте:

| Тип документа       | Событие    | URL                              |
|---------------------|------------|----------------------------------|
| Заказ покупателя    | Создание   | `https://<ваш_хост>/webhook`    |
| Заказ покупателя    | Изменение  | `https://<ваш_хост>/webhook`    |
| Отгрузка            | Создание   | `https://<ваш_хост>/webhook`    |
| Отгрузка            | Изменение  | `https://<ваш_хост>/webhook`    |

Если задан `WEBHOOK_BEARER_TOKEN` в `.env` — добавьте его в настройки вебхука.

## 5. Проверка работы

1. Создайте контрагента-оптовика (тег «Оптовик», ПЛ = Да, скидка 10%).
2. Создайте обычный товар (в любой группе кроме «Акция»).
3. Создайте акционный товар (в группе «Акция»).
4. Создайте **Заказ покупателя** с этим контрагентом, добавьте оба товара.
5. Убедитесь:
   - обычный товар получил скидку 10%
   - акционный товар — скидка 0%
6. Попробуйте вручную изменить скидку → при сохранении документа система вернёт правильное значение.

## 6. Логика работы (кратко)

```
При создании/изменении Заказа покупателя или Отгрузки:
  1. Проверяем контрагента:
     — флажок «Программа лояльности» = Да?
     — тег «Оптовик» есть?
     — «Скидка по ПЛ (%)» > 0?
  2. Для каждой позиции:
     — товар в группе «Акция»? → скидка = 0%
     — иначе → скидка = % из карточки контрагента
  3. Обновляем документ со всеми позициями
```

Система всегда пересчитывает скидки заново при любом изменении документа.
